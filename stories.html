<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stories - HaiFire</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <link rel="stylesheet" href="aistudio_Style.css">
    <style>
        /* --- Layout Fixes --- */
        html, body { height: 100%; overflow: hidden; margin: 0; padding: 0; background: var(--bg-primary); }
        .app-container { display: flex; width: 100%; height: 100%; }

        /* Sidebar Fixes */
        #left-sidebar {
            flex-shrink: 0; width: 260px; display: flex; flex-direction: column;
            border-right: 1px solid var(--border-color); background-color: var(--bg-secondary);
            z-index: 1000; transition: transform 0.3s ease;
        }

        @media (max-width: 1023px) {
            #left-sidebar { position: fixed; top: 0; left: 0; bottom: 0; transform: translateX(-100%); }
            body.left-sidebar-open #left-sidebar { transform: translateX(0); }
            body.left-sidebar-open .overlay { opacity: 1; visibility: visible; }
        }

        .main-wrapper { flex: 1; display: flex; flex-direction: column; height: 100%; position: relative; width: 100%; }
        .content-area { flex: 1; overflow-y: auto; scroll-behavior: smooth; -webkit-overflow-scrolling: touch; padding-bottom: 20px; }
        .content-wrapper { max-width: 700px; margin: 0 auto; padding: 20px 16px; }

        /* --- Story Specific Styles --- */
        .story-scroll-container {
            display: flex; gap: 15px; overflow-x: auto; padding: 10px 5px 20px 5px;
            scroll-snap-type: x mandatory; -ms-overflow-style: none; scrollbar-width: none;
        }
        .story-scroll-container::-webkit-scrollbar { display: none; }

        .story-item {
            flex: 0 0 80px; display: flex; flex-direction: column; align-items: center;
            scroll-snap-align: start; cursor: pointer; transition: transform 0.2s;
        }
        .story-item:hover { transform: scale(1.05); }

        .story-ring {
            width: 70px; height: 70px; border-radius: 50%; padding: 2px;
            background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);
            margin-bottom: 5px; position: relative;
        }
        .story-img {
            width: 100%; height: 100%; border-radius: 50%;
            border: 2px solid var(--bg-primary); object-fit: cover; background: var(--bg-tertiary);
        }
        .story-user { font-size: 0.8rem; color: var(--text-primary); text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; }

        .my-story-section {
            background: var(--bg-secondary); border-radius: 12px; border: 1px solid var(--border-color);
            padding: 20px; margin-bottom: 20px; display: flex; align-items: center; gap: 15px;
        }
        .my-story-info { flex: 1; }
        .my-story-actions { display: flex; gap: 10px; }

        /* Fullscreen Modal */
        .story-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 2000; display: none; flex-direction: column;
        }
        
        .story-progress-container {
            position: absolute; top: 10px; left: 10px; right: 10px;
            height: 3px; background: rgba(255,255,255,0.3); border-radius: 2px; z-index: 2002;
        }
        .story-bar { height: 100%; background: #fff; width: 0%; border-radius: 2px; transition: width 0.1s linear; }
        
        .story-view-header {
            position: absolute; top: 20px; left: 0; width: 100%;
            padding: 10px 15px; display: flex; align-items: center; gap: 10px; color: #fff;
            z-index: 2001; background: linear-gradient(to bottom, rgba(0,0,0,0.6), transparent);
        }
        .view-avatar { width: 35px; height: 35px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.5); object-fit: cover;}
        .story-full-img { width: 100%; height: 100%; object-fit: contain; }
        .close-area {
            position: absolute; top: 20px; right: 20px; z-index: 2002;
            color: white; cursor: pointer; padding: 10px;
        }

        /* Skeleton */
        .sk-story-circle { width: 70px; height: 70px; border-radius: 50%; background: var(--bg-tertiary); animation: pulse 1.5s infinite; flex-shrink: 0; }
        @keyframes pulse { 0% {opacity:0.5;} 50% {opacity:1;} 100% {opacity:0.5;} }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="overlay" id="overlay"></div>
        <aside id="left-sidebar">
            <div class="sidebar-header">HaiFire</div>
            <div class="sidebar-content">
                <nav class="sidebar-nav">
                    <a href="home.html"><span class="material-symbols-outlined">home</span>Home</a>
                    <a href="search.html"><span class="material-symbols-outlined">search</span>Search</a>
                    <a href="post.html"><span class="material-symbols-outlined">add_circle</span>Create</a>
                    <a href="requests.html"><span class="material-symbols-outlined">notifications</span>Alerts</a>
                    <a href="dm.html"><span class="material-symbols-outlined">chat</span>Messages</a>
                    <a href="profile.html"><span class="material-symbols-outlined">person</span>Profile</a>
                </nav>
            </div>
            <div class="sidebar-footer">
                <button class="btn btn-secondary" id="logoutBtn" style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <span class="material-symbols-outlined">logout</span> Logout
                </button>
            </div>
        </aside>

        <div class="main-wrapper">
            <header class="main-header">
                <button id="menu-toggle" class="icon-button" style="display: block;">
                    <span class="material-symbols-outlined">menu</span>
                </button>
                <div class="header-title" style="flex:1; margin-left: 10px;">Stories</div>
                <button class="icon-button" onclick="loadStories()">
                    <span class="material-symbols-outlined">refresh</span>
                </button>
            </header>

            <main class="content-area">
                <div class="content-wrapper">
                    <!-- My Story Section -->
                    <div id="myStorySection" class="my-story-section">
                        <div class="story-ring" id="myStoryRing">
                            <img id="myAvatar" src="" class="story-img">
                        </div>
                        <div class="my-story-info">
                            <div style="font-weight: 600; font-size: 1rem;">My Story</div>
                            <div id="myStoryStatus" style="font-size: 0.85rem; color: var(--text-secondary);">Add a photo</div>
                        </div>
                        <div class="my-story-actions">
                            <input type="file" id="storyInput" hidden accept="image/*">
                            <button class="icon-button" style="background: var(--bg-tertiary); color: var(--text-active);" onclick="document.getElementById('storyInput').click()">
                                <span class="material-symbols-outlined">add_a_photo</span>
                            </button>
                            <button class="icon-button" id="viewMyStoryBtn" style="display: none; background: var(--bg-tertiary);" onclick="viewMyStory()">
                                <span class="material-symbols-outlined">visibility</span>
                            </button>
                            <button class="icon-button" id="deleteMyStoryBtn" style="display: none; background: var(--bg-tertiary); color: var(--error-color);" onclick="deleteStory()">
                                <span class="material-symbols-outlined">delete</span>
                            </button>
                        </div>
                    </div>

                    <h3 style="margin-bottom: 15px; font-size: 1.1rem; padding-left: 5px;">Recent Updates</h3>
                    
                    <!-- Friends Stories -->
                    <div id="friendsLoader" class="story-scroll-container">
                        <div class="sk-story-circle"></div><div class="sk-story-circle"></div>
                        <div class="sk-story-circle"></div><div class="sk-story-circle"></div>
                    </div>

                    <div class="story-scroll-container" id="storyContainer" style="display: none;"></div>
                    <div id="noStoriesMsg" class="text-center" style="display:none; color:var(--text-secondary); margin-top:20px;">
                        No active stories from friends.
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Story Viewer Modal -->
    <div class="story-modal" id="storyViewer">
        <div class="story-progress-container"><div class="story-bar" id="storyBar"></div></div>
        
        <div class="close-area" onclick="closeStory()">
            <span class="material-symbols-outlined" style="font-size: 30px; text-shadow: 0 2px 4px rgba(0,0,0,0.5);">close</span>
        </div>

        <div class="story-view-header">
            <img src="" id="viewAvatar" class="view-avatar">
            <div style="display:flex; flex-direction:column;">
                <span id="viewUser" style="font-weight:600; font-size: 0.95rem;"></span>
                <span style="font-size: 0.75rem; opacity: 0.8;">Just now</span>
            </div>
        </div>
        
        <img src="" id="viewImg" class="story-full-img">
    </div>

    <!-- Scripts -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
        const firebaseConfig = { apiKey: "AIzaSyB2mV0bya1fD17kQZQeMP11a9mlK-sVEnc", authDomain: "citas-bd0a3.firebaseapp.com", databaseURL: "https://citas-bd0a3-default-rtdb.firebaseio.com", projectId: "citas-bd0a3", storageBucket: "citas-bd0a3.firebasestorage.app", messagingSenderId: "1082213903517", appId: "1:1082213903517:web:22409e051e5442f37ef874", measurementId: "G-TXKMGDLMVB" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const IMGBB_API_KEY = "7184e56bb0953c0545409c441c402a66";
        let currentUser;
        let myCurrentStoryData = null;

        // Sidebar Logic
        const menuToggle = document.getElementById('menu-toggle');
        const overlay = document.getElementById('overlay');
        const body = document.body;
        if (window.innerWidth >= 1024) document.getElementById('menu-toggle').style.display = 'none';
        menuToggle.addEventListener('click', () => body.classList.toggle('left-sidebar-open'));
        overlay.addEventListener('click', () => body.classList.remove('left-sidebar-open'));
        document.getElementById('logoutBtn').addEventListener('click', () => auth.signOut());

        auth.onAuthStateChanged(async user => {
            if(user) { 
                currentUser = user; 
                await loadMyProfile();
                checkMyStory();
                loadStories(); 
            } else window.location.href = 'index.html';
        });

        async function loadMyProfile() {
            try {
                const doc = await db.collection('users').doc(currentUser.uid).get();
                if(doc.exists) {
                    const data = doc.data();
                    document.getElementById('myAvatar').src = data.avatar || `https://ui-avatars.com/api/?name=${data.username}`;
                }
            } catch(e) { console.error("Profile load error", e); }
        }

        async function checkMyStory() {
            try {
                const doc = await db.collection('stories').doc(currentUser.uid).get();
                const viewBtn = document.getElementById('viewMyStoryBtn');
                const delBtn = document.getElementById('deleteMyStoryBtn');
                const statusText = document.getElementById('myStoryStatus');

                if(doc.exists) {
                    const data = doc.data();
                    // FIX: Safe timestamp check
                    let expiry;
                    if (data.expiresAt && typeof data.expiresAt.toMillis === 'function') {
                        expiry = data.expiresAt.toMillis();
                    } else if (data.expiresAt) {
                        // Fallback if stored as Number or Date object
                        expiry = new Date(data.expiresAt).getTime();
                    } else {
                        expiry = 0; // Invalid/Missing, assume expired
                    }

                    if(Date.now() < expiry) {
                        myCurrentStoryData = data;
                        statusText.textContent = "Active for 24h";
                        statusText.style.color = "var(--accent-color)";
                        viewBtn.style.display = "flex";
                        delBtn.style.display = "flex";
                    } else {
                        myCurrentStoryData = null;
                        statusText.textContent = "Story expired";
                        statusText.style.color = "var(--text-secondary)";
                        viewBtn.style.display = "none";
                        delBtn.style.display = "none";
                    }
                } else {
                    myCurrentStoryData = null;
                    statusText.textContent = "Share a photo";
                    viewBtn.style.display = "none";
                    delBtn.style.display = "none";
                }
            } catch(e) {
                console.error("Error checking story:", e);
            }
        }

        document.getElementById('storyInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if(!file) return;

            const statusText = document.getElementById('myStoryStatus');
            statusText.textContent = "Uploading...";
            
            const formData = new FormData();
            formData.append('image', file);
            
            try {
                const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method:'POST', body:formData });
                const data = await res.json();
                
                if(data.success) {
                    const expiresAt = new Date(Date.now() + 24 * 60 * 60 * 1000);
                    await db.collection('stories').doc(currentUser.uid).set({
                        userId: currentUser.uid,
                        imageUrl: data.data.url,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        expiresAt: firebase.firestore.Timestamp.fromDate(expiresAt)
                    });
                    checkMyStory();
                }
            } catch(e) { 
                console.error(e); 
                alert("Upload failed"); 
                statusText.textContent = "Upload failed";
            }
        });

        async function deleteStory() {
            if(confirm("Delete your story?")) {
                await db.collection('stories').doc(currentUser.uid).delete();
                checkMyStory();
            }
        }

        function viewMyStory() {
            if(myCurrentStoryData) {
                const avatarSrc = document.getElementById('myAvatar').src;
                openStory(myCurrentStoryData.imageUrl, "You", avatarSrc);
            }
        }

        async function loadStories() {
            const container = document.getElementById('storyContainer');
            const loader = document.getElementById('friendsLoader');
            const noMsg = document.getElementById('noStoriesMsg');
            
            try {
                const snapshot = await db.collection('stories').orderBy('timestamp', 'desc').limit(10).get();
                
                container.innerHTML = '';
                loader.style.display = 'none';
                container.style.display = 'flex';
                
                let count = 0;
                const now = Date.now();

                if(snapshot.empty) {
                    noMsg.style.display = 'block';
                    return;
                }

                for(let doc of snapshot.docs) {
                    const data = doc.data();
                    
                    // FIX: Safe timestamp check inside loop
                    let expiry;
                    if (data.expiresAt && typeof data.expiresAt.toMillis === 'function') {
                        expiry = data.expiresAt.toMillis();
                    } else if (data.expiresAt) {
                        expiry = new Date(data.expiresAt).getTime();
                    } else {
                        expiry = 0; 
                    }

                    if(data.userId === currentUser.uid || now > expiry) continue;

                    count++;
                    
                    let uData = { username: 'User', avatar: '' };
                    try {
                        const uDoc = await db.collection('users').doc(data.userId).get();
                        if(uDoc.exists) uData = uDoc.data();
                    } catch(e) {}

                    const avatar = uData.avatar || `https://ui-avatars.com/api/?name=${uData.username}`;

                    const div = document.createElement('div');
                    div.className = 'story-item';
                    div.onclick = () => openStory(data.imageUrl, uData.username, avatar);
                    div.innerHTML = `
                        <div class="story-ring">
                            <img src="${avatar}" class="story-img">
                        </div>
                        <div class="story-user">${uData.username}</div>
                    `;
                    container.appendChild(div);
                }

                if(count === 0) noMsg.style.display = 'block';
            } catch(e) {
                console.error("Error loading stories:", e);
                loader.style.display = 'none';
            }
        }

        let storyTimer;
        let progressInterval;

        function openStory(imgUrl, username, avatarUrl) {
            const modal = document.getElementById('storyViewer');
            document.getElementById('viewImg').src = imgUrl;
            document.getElementById('viewUser').textContent = username;
            document.getElementById('viewAvatar').src = avatarUrl;
            
            modal.style.display = 'flex';
            const bar = document.getElementById('storyBar');
            bar.style.width = '0%';
            
            let width = 0;
            clearInterval(progressInterval);
            progressInterval = setInterval(() => {
                width += 1;
                bar.style.width = width + '%';
                if(width >= 100) clearInterval(progressInterval);
            }, 50); 
            
            clearTimeout(storyTimer);
            storyTimer = setTimeout(closeStory, 5000); 
        }

        function closeStory() {
            document.getElementById('storyViewer').style.display = 'none';
            document.getElementById('storyBar').style.width = '0%';
            clearTimeout(storyTimer);
            clearInterval(progressInterval);
        }
    </script>
</body>
</html>