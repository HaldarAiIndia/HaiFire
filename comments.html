<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comments - HaiFire</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <link rel="stylesheet" href="aistudio_Style.css">
    <style>
        .main-wrapper { height: 100vh; display: flex; flex-direction: column; }
        .content-area { flex: 1; overflow-y: auto; padding-bottom: 80px; }
        
        /* Input Area fixed at bottom */
        .comment-input-area {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            padding: 10px 16px;
            display: flex; gap: 10px; align-items: center;
            z-index: 50;
        }
        @media(min-width: 1024px) { .comment-input-area { left: var(--sidebar-width); width: calc(100% - var(--sidebar-width)); } }

        .comment-item {
            display: flex; gap: 12px; padding: 12px;
            border-bottom: 1px solid var(--border-color);
        }
        .c-avatar { width: 32px; height: 32px; border-radius: 50%; }
        .c-bubble { flex: 1; }
        .c-user { font-weight: 600; font-size: 0.9rem; color: var(--text-primary); }
        .c-text { font-size: 0.95rem; color: var(--text-secondary); margin-top: 2px; }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="overlay" id="overlay"></div>
        <aside id="left-sidebar">
            <div class="sidebar-header">HaiFire</div>
            <div class="sidebar-content">
                <nav class="sidebar-nav">
                    <a href="home.html"><span class="material-symbols-outlined">home</span>Home</a>
                    <a href="search.html"><span class="material-symbols-outlined">search</span>Search</a>
                    <a href="post.html"><span class="material-symbols-outlined">add_circle</span>Create</a>
                    <a href="requests.html"><span class="material-symbols-outlined">notifications</span>Alerts</a>
                    <a href="dm.html"><span class="material-symbols-outlined">chat</span>Messages</a>
                    <a href="profile.html"><span class="material-symbols-outlined">person</span>Profile</a>
                </nav>
            </div>
        </aside>

        <div class="main-wrapper">
            <header class="main-header">
                <button class="icon-button" onclick="history.back()"><span class="material-symbols-outlined">arrow_back</span></button>
                <div class="header-title">Comments</div>
            </header>

            <main class="content-area">
                <div class="content-wrapper" style="padding-bottom: 60px;">
                    <!-- Original Post Mini View -->
                    <div class="post-card" id="originalPost" style="border-left: 4px solid var(--text-active);">
                        <div class="skeleton" style="height: 20px; width: 60%; margin-bottom: 10px;"></div>
                        <div class="skeleton" style="height: 14px; width: 90%;"></div>
                    </div>

                    <h3 style="margin: 20px 0 10px; font-size: 1rem; color: var(--text-secondary);">Discussion</h3>
                    
                    <div id="commentsList">
                        <!-- Comments go here -->
                        <div class="text-center" style="color:var(--text-muted)">Loading...</div>
                    </div>
                </div>
            </main>

            <div class="comment-input-area">
                <input type="text" id="commentInput" placeholder="Write a comment..." style="border-radius: 20px;">
                <button class="send-button" id="sendBtn"><span class="material-symbols-outlined">send</span></button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
        const firebaseConfig = { apiKey: "AIzaSyB2mV0bya1fD17kQZQeMP11a9mlK-sVEnc", authDomain: "citas-bd0a3.firebaseapp.com", databaseURL: "https://citas-bd0a3-default-rtdb.firebaseio.com", projectId: "citas-bd0a3", storageBucket: "citas-bd0a3.firebasestorage.app", messagingSenderId: "1082213903517", appId: "1:1082213903517:web:22409e051e5442f37ef874", measurementId: "G-TXKMGDLMVB" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        const params = new URLSearchParams(window.location.search);
        const postId = params.get('postId');
        let currentUser;
        let currentUsername;

        if(!postId) window.location.href = 'home.html';

        auth.onAuthStateChanged(async user => {
            if(user) {
                currentUser = user;
                const uDoc = await db.collection('users').doc(user.uid).get();
                currentUsername = uDoc.data().username;
                loadPost();
                loadComments();
            } else window.location.href = 'index.html';
        });

        async function loadPost() {
            const doc = await db.collection('posts').doc(postId).get();
            if(doc.exists) {
                const data = doc.data();
                document.getElementById('originalPost').innerHTML = `
                    <div style="font-weight:600; margin-bottom:5px;">${data.username}</div>
                    <div style="color:var(--text-secondary); font-size:0.95rem;">${data.content}</div>
                `;
            }
        }

        function loadComments() {
            db.collection('posts').doc(postId).collection('comments').orderBy('timestamp', 'asc')
            .onSnapshot(snapshot => {
                const list = document.getElementById('commentsList');
                list.innerHTML = '';
                if(snapshot.empty) list.innerHTML = '<div class="text-center" style="margin-top:20px; color:var(--text-muted)">No comments yet. Be the first!</div>';
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const div = document.createElement('div');
                    div.className = 'comment-item';
                    div.innerHTML = `
                        <img src="https://ui-avatars.com/api/?name=${data.username}" class="c-avatar">
                        <div class="c-bubble">
                            <div class="c-user">${data.username}</div>
                            <div class="c-text">${data.content}</div>
                        </div>
                    `;
                    list.appendChild(div);
                });
            });
        }

        document.getElementById('sendBtn').addEventListener('click', async () => {
            const input = document.getElementById('commentInput');
            const text = input.value.trim();
            if(!text) return;

            input.value = '';
            await db.collection('posts').doc(postId).collection('comments').add({
                userId: currentUser.uid,
                username: currentUsername,
                content: text,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
        });
    </script>
</body>
</html>