<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - HaiFire</title>
    <link rel="icon" type="image/x-icon" href="solution.png">
    <!-- Google Fonts and Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        :root {
            --bg-primary: #17181a;
            --bg-secondary: #202225;
            --bg-tertiary: #2c2f33;
            --bg-hover: #35383c;
            --text-primary: #f0f2f5;
            --text-secondary: #a8b3cf;
            --text-active: #82aaff;
            --border-color: #3a3d42;
            --error-color: #ff8a80;
            --success-color: #89ddff;
            --warning-color: #ffd700;
            --nav-drawer-width: 80px;
            --font-family: 'Inter', sans-serif;
        }

        /* --- Base & Reset --- */
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; overflow: hidden; background-color: var(--bg-primary); color: var(--text-primary); font-family: var(--font-family); font-size: 16px; }
        a { text-decoration: none; color: var(--text-active); }
        a:hover { text-decoration: underline; }
        button { background: none; border: none; cursor: pointer; font-family: inherit; }
        input:disabled, textarea:disabled { background-color: var(--bg-tertiary); opacity: 0.7; cursor: not-allowed; }
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 300, 'GRAD' 0, 'opsz' 24; font-size: 28px; color: var(--text-secondary); user-select: none; vertical-align: middle; }

        /* --- Animations --- */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- Main App Layout --- */
        .app-container { width: 100%; height: 100%; display: flex; flex-direction: column; }
        
        /* --- Top Navigation Bar --- */
        .app-header { display: flex; align-items: center; padding: 0 16px; height: 60px; background-color: rgba(32, 34, 37, 0.8); backdrop-filter: blur(10px); border-bottom: 1px solid var(--border-color); flex-shrink: 0; position: sticky; top: 0; z-index: 100; }
        .icon-button { 
            padding: 8px; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            transition: background-color 0.2s, transform 0.1s ease;
        }
        .icon-button:hover { background-color: var(--bg-hover); }
        .icon-button:active { transform: scale(0.92); }
        .header-title { font-size: 1.25rem; font-weight: 600; margin-left: 16px; }

        /* --- Navigation Drawer (Side Menu) --- */
        #nav-drawer { position: fixed; top: 0; left: 0; width: var(--nav-drawer-width); height: 100%; background-color: var(--bg-secondary); z-index: 1001; transform: translateX(-100%); transition: transform 0.3s ease-in-out; display: flex; flex-direction: column; }
        .nav-drawer-header { padding: 16px; text-align: center; font-size: 1.5rem; font-weight: 700; border-bottom: 1px solid var(--border-color); }
        .nav-drawer-header .material-symbols-outlined { font-size: 32px; }
        .nav-drawer-content { flex-grow: 1; padding: 16px 0; }
        .nav-link { 
            display: flex; 
            align-items: center; 
            justify-content: center;
            padding: 18px;
            font-weight: 500; 
            color: var(--text-secondary); 
            transition: background-color 0.2s, transform 0.1s ease;
            position: relative;
        }
        .nav-link.active { background-color: var(--bg-tertiary); }
        .nav-link.active .material-symbols-outlined { color: var(--text-primary); }
        .nav-link:hover { background-color: var(--bg-hover); }
        .nav-link:active { transform: scale(0.95); }
        .nav-drawer-footer { padding: 16px 0; border-top: 1px solid var(--border-color); }
        .admin-info { display: none; }

        /* --- Overlay for Nav Drawer --- */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        body.nav-open #nav-drawer { transform: translateX(0); }
        body.nav-open .overlay { opacity: 1; visibility: visible; }
        
        /* --- Main Content Area --- */
        .content-area { flex-grow: 1; overflow-y: auto; padding: 16px; }
        .app-screen { display: none; }
        .app-screen.active { display: block; animation: fadeIn 0.5s; }

        /* --- Dashboard --- */
        .stats-grid { display: grid; grid-template-columns: 1fr; gap: 16px; }
        @media (min-width: 600px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (min-width: 1200px) { .stats-grid { grid-template-columns: repeat(4, 1fr); } }
        .stat-card { background-color: var(--bg-secondary); padding: 24px; border-radius: 12px; border: 1px solid var(--border-color); display: flex; align-items: center; gap: 20px; }
        .stat-card .icon { font-size: 32px; padding: 12px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .stat-card .icon.users { background-color: rgba(130, 170, 255, 0.1); color: var(--text-active); }
        .stat-card .icon.posts { background-color: rgba(137, 221, 255, 0.1); color: var(--success-color); }
        .stat-card .icon.notifications { background-color: rgba(255, 215, 0, 0.1); color: var(--warning-color); }
        .stat-card .icon.banners { background-color: rgba(199, 146, 255, 0.1); color: #c792ff; }
        .stat-info h3 { font-size: 1.75rem; font-weight: 700; }
        .stat-info p { font-size: 0.8rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }

        /* --- Management Cards & Tables --- */
        .content-card { background-color: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; margin-bottom: 24px; }
        .card-header { padding: 16px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .card-header h2 { font-size: 1.1rem; }
        .card-body { padding: 16px; }
        .table-wrapper { overflow-x: auto; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th, .data-table td { padding: 14px 16px; text-align: left; border-bottom: 1px solid var(--border-color); white-space: nowrap; vertical-align: middle; }
        .data-table td.wrap { white-space: normal; word-break: break-all; }
        .data-table th { font-size: 0.75rem; text-transform: uppercase; color: var(--text-secondary); font-weight: 600; }
        .data-table tbody tr:last-child td { border-bottom: none; }
        .data-table tbody tr:hover { background-color: var(--bg-tertiary); }
        .table-actions { display: flex; gap: 8px; }
        .icon-button.delete .material-symbols-outlined { color: var(--error-color); }
        .icon-button.edit .material-symbols-outlined { color: var(--success-color); }
        .table-placeholder { text-align: center; padding: 48px; color: var(--text-secondary); }
        .spinner { width: 32px; height: 32px; border: 4px solid var(--border-color); border-top-color: var(--text-active); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto; }
        
        /* --- Login & Form Styles --- */
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg-primary); z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 16px; }
        .login-box { background-color: var(--bg-secondary); padding: 32px; border-radius: 12px; width: 100%; max-width: 400px; text-align: center; }
        .login-box h1 { margin-bottom: 16px; }
        .login-box p { margin-bottom: 24px; color: var(--text-secondary); }
        .form-group { margin-bottom: 20px; text-align: left; }
        .form-group label { display: block; margin-bottom: 8px; font-size: 0.9rem; font-weight: 500; }
        .form-group input, .form-group textarea { width: 100%; background-color: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 6px; padding: 12px; font-size: 1rem; color: var(--text-primary); font-family: inherit; }
        .form-group textarea { resize: vertical; min-height: 80px; }
        .btn { 
            padding: 10px 20px; 
            font-weight: 600; 
            border-radius: 8px; 
            transition: opacity 0.2s, transform 0.1s ease;
        }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn:active { transform: scale(0.97); }
        .btn-primary { background-color: var(--text-active); color: var(--bg-primary); }
        .btn-secondary { background: none; border: 1px solid var(--border-color); color: var(--text-primary); }
        .btn-danger { background-color: var(--error-color); color: var(--bg-primary); }
        .btn-full-width { width: 100%; padding: 12px 24px; }
        .error-message { color: var(--error-color); margin-top: 16px; min-height: 1.2em; }
        .auth-divider { font-size: 0.8rem; color: var(--text-secondary); text-align: center; margin: 24px 0; position: relative; }
        .auth-divider::before, .auth-divider::after { content: ''; position: absolute; top: 50%; width: 40%; height: 1px; background-color: var(--border-color); }
        .auth-divider::before { left: 0; } .auth-divider::after { right: 0; }
        .btn-google { display: flex; justify-content: center; align-items: center; gap: 12px; }
        .btn-google svg { width: 18px; height: 18px; }

        /* --- Modal & Toast --- */
        .modal-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 3000; display: none; align-items: center; justify-content: center; background-color: rgba(0,0,0,0.7); padding: 16px; }
        .modal-container.visible { display: flex; }
        .modal-content { background-color: var(--bg-secondary); border-radius: 12px; padding: 24px; width: 100%; max-width: 500px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .modal-header h3 { margin-bottom: 0; }
        .modal-body { margin-bottom: 24px; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 12px; }
        .toast-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 4000; width: calc(100% - 32px); max-width: 500px; }
        .toast { background-color: var(--bg-tertiary); padding: 12px 16px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); animation: fadeIn 0.3s; }
        .toast.error { border-left: 4px solid var(--error-color); }
        .toast.success { border-left: 4px solid var(--success-color); }
    </style>
</head>
<body>

    <!-- Login Screen -->
    <div id="login-overlay">
        <div class="login-box">
            <h1>Admin Login</h1>
            <p>Please log in with an admin account.</p>
            <form id="login-form">
                <div class="form-group"><label for="login-email">Email</label><input type="email" id="login-email" required></div>
                <div class="form-group"><label for="login-password">Password</label><input type="password" id="login-password" required></div>
                <button type="submit" class="btn btn-primary btn-full-width" id="login-button">Login</button>
                <p class="error-message" id="login-error"></p>
            </form>
            <div class="auth-divider">OR</div>
            <button class="btn btn-secondary btn-full-width btn-google" id="google-login-btn">
                <svg aria-hidden="true" focusable="false" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 488 512"><path fill="currentColor" d="M488 261.8C488 403.3 391.1 504 248 504 110.8 504 0 393.2 0 256S110.8 8 248 8c66.8 0 126 21.2 172.9 60.7l-67 67C334.6 114.6 293.4 96 248 96c-88.8 0-160 72.2-160 160s71.2 160 160 160c92.6 0 145.5-68.2 149.9-105.5H248V256h239.8c.2 1.5 1 2.9 1.2 4.2z"></path></svg>
                Sign in with Google
            </button>
        </div>
    </div>

    <!-- Main Application Container -->
    <div class="app-container" style="display: none;">
        <header class="app-header">
            <button class="icon-button" id="menu-toggle"><span class="material-symbols-outlined">menu</span></button>
            <h1 class="header-title" id="header-title">Dashboard</h1>
        </header>

        <main class="content-area">
            <!-- Dashboard Screen -->
            <div id="dashboard-screen" class="app-screen">
                <!-- Stats -->
                <div class="stats-grid">
                    <div class="stat-card"><div class="icon users"><span class="material-symbols-outlined">group</span></div><div class="stat-info"><h3 id="total-users-stat">...</h3><p>Total Users</p></div></div>
                    <div class="stat-card"><div class="icon posts"><span class="material-symbols-outlined">article</span></div><div class="stat-info"><h3 id="total-posts-stat">...</h3><p>Total Posts</p></div></div>
                    <div class="stat-card"><div class="icon notifications"><span class="material-symbols-outlined">notifications</span></div><div class="stat-info"><h3 id="total-notifications-stat">...</h3><p>Total Notifications</p></div></div>
                    <div class="stat-card"><div class="icon banners"><span class="material-symbols-outlined">photo_library</span></div><div class="stat-info"><h3 id="total-banners-stat">...</h3><p>Total Banners</p></div></div>
                </div>
            </div>

            <!-- User Management Screen -->
            <div id="users-screen" class="app-screen">
                <div class="content-card">
                    <div class="card-header">
                        <h2>All Users</h2>
                        <button class="btn btn-primary" id="add-user-btn">Add User</button>
                    </div>
                    <div class="table-wrapper"><table class="data-table"><thead><tr><th>Name</th><th>Email</th><th>Handel</th><th>Joined</th><th>Actions</th></tr></thead><tbody id="users-table-body"></tbody></table></div>
                </div>
            </div>

            <!-- Post Management Screen -->
            <div id="posts-screen" class="app-screen">
                <div class="content-card">
                    <div class="card-header">
                        <h2>All Posts</h2>
                        <button class="btn btn-primary" id="add-post-btn">Add Post</button>
                    </div>
                    <div class="table-wrapper"><table class="data-table"><thead><tr><th>Title</th><th>Author</th><th>Created</th><th>Actions</th></tr></thead><tbody id="posts-table-body"></tbody></table></div>
                </div>
            </div>

             <!-- Notification Management Screen -->
            <div id="notifications-screen" class="app-screen">
                <div class="content-card">
                    <div class="card-header">
                        <h2>All Notifications</h2>
                        <button class="btn btn-primary" id="add-notification-btn">Add Notification</button>
                    </div>
                    <div class="table-wrapper"><table class="data-table"><thead><tr><th>Message</th><th>Triggered By</th><th>Type</th><th>Created</th><th>Actions</th></tr></thead><tbody id="notifications-table-body"></tbody></table></div>
                </div>
            </div>

            <!-- Banner Management Screen -->
            <div id="banner-screen" class="app-screen">
                <div class="content-card">
                    <div class="card-header"><h2>Add New Banner</h2></div>
                    <div class="card-body">
                        <form id="add-banner-form">
                            <div class="form-group">
                                <label for="banner-name">Banner Name</label>
                                <input type="text" id="banner-name" placeholder="e.g., Summer Sale" required>
                            </div>
                            <div class="form-group">
                                <label for="banner-image-url">Banner Image URL</label>
                                <input type="url" id="banner-image-url" placeholder="https://example.com/banner.jpg" required>
                            </div>
                            <div class="form-group">
                                <label for="banner-redirect-url">Banner Redirect URL (optional)</label>
                                <input type="url" id="banner-redirect-url" placeholder="https://example.com/promo-page">
                            </div>
                            <button type="submit" id="add-banner-btn" class="btn btn-primary">Add Banner</button>
                        </form>
                    </div>
                </div>
                <div class="content-card">
                    <div class="card-header"><h2>Active Banners</h2></div>
                    <div class="table-wrapper">
                        <table class="data-table">
                            <thead><tr><th>Name</th><th>Actions</th></tr></thead>
                            <tbody id="banners-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Navigation Drawer -->
    <aside id="nav-drawer">
        <div class="nav-drawer-header"><span class="material-symbols-outlined">rocket_launch</span></div>
        <div class="nav-drawer-content">
            <a href="#" class="nav-link active" data-target="dashboard-screen" data-title="Dashboard"><span class="material-symbols-outlined">dashboard</span></a>
            <a href="#" class="nav-link" data-target="users-screen" data-title="Users"><span class="material-symbols-outlined">group</span></a>
            <a href="#" class="nav-link" data-target="posts-screen" data-title="Posts"><span class="material-symbols-outlined">article</span></a>
            <a href="#" class="nav-link" data-target="notifications-screen" data-title="Notifications"><span class="material-symbols-outlined">notifications</span></a>
            <a href="#" class="nav-link" data-target="banner-screen" data-title="Banners"><span class="material-symbols-outlined">campaign</span></a>
        </div>
        <div class="nav-drawer-footer">
            <a href="#" class="nav-link" id="logout-btn"><span class="material-symbols-outlined">logout</span></a>
            <div class="admin-info">Logged in as: <br><strong id="admin-email"></strong></div>
        </div>
    </aside>
    <div class="overlay" id="overlay"></div>

    <!-- Modal and Toast Containers -->
    <div class="modal-container" id="confirmation-modal">
        <div class="modal-content">
            <h3 id="modal-title">Confirm Action</h3>
            <p id="modal-text">Are you sure? This cannot be undone.</p>
            <div class="modal-actions"><button class="btn btn-secondary" id="modal-cancel-btn">Cancel</button><button class="btn btn-danger" id="modal-confirm-btn">Confirm</button></div>
        </div>
    </div>
    
    <div class="modal-container" id="edit-create-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="edit-create-modal-title"></h3>
                <button class="icon-button" id="edit-create-modal-close-btn"><span class="material-symbols-outlined">close</span></button>
            </div>
            <div class="modal-body">
                <form id="edit-create-form"></form>
            </div>
        </div>
    </div>
    
    <div class="toast-container" id="toast-container"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // ===================================================================================
            // CRITICAL: REPLACE THIS WITH YOUR OWN FIREBASE PROJECT CONFIGURATION
            // ===================================================================================
            const firebaseConfig = {
  apiKey: "AIzaSyCGEGXT8e1uY3b_NXQTXomF3odjk88AftU",
  authDomain: "haifire-india.firebaseapp.com",
  databaseURL: "https://haifire-india-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "haifire-india",
  storageBucket: "haifire-india.firebasestorage.app",
  messagingSenderId: "25424393934",
  appId: "1:25424393934:web:a678d02ad684034d4b429f"
};
            // ===================================================================================

            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.firestore();

            const loginOverlay = document.getElementById('login-overlay');
            const appContainer = document.querySelector('.app-container');
            const navLinks = document.querySelectorAll('.nav-link');
            const appScreens = document.querySelectorAll('.app-screen');
            const headerTitle = document.getElementById('header-title');
            const menuToggle = document.getElementById('menu-toggle');
            const overlay = document.getElementById('overlay');
            const logoutBtn = document.getElementById('logout-btn');

            let bannersListener = null;

            const loadingHTML = (cols) => `<tr><td colspan="${cols}" class="table-placeholder"><div class="spinner"></div></td></tr>`;
            const noDataHTML = (item, cols) => `<tr><td colspan="${cols}" class="table-placeholder">No ${item} found.</td></tr>`;

            // --- AUTHENTICATION ---
            auth.onAuthStateChanged(async user => {
                if (user) {
                    try {
                        const userDoc = await db.collection('users').doc(user.uid).get();
                        if (userDoc.exists && userDoc.data().isAdmin === true) {
                            loginOverlay.style.display = 'none';
                            appContainer.style.display = 'flex';
                            document.getElementById('admin-email').textContent = user.email;
                            initializeApp();
                        } else {
                            showToast("Access Denied. You are not an admin.", "error");
                            auth.signOut();
                        }
                    } catch (error) { showToast("Error verifying admin status.", "error"); auth.signOut(); }
                } else {
                    loginOverlay.style.display = 'flex';
                    appContainer.style.display = 'none';
                    document.body.classList.remove('nav-open');
                }
            });

            document.getElementById('login-form').addEventListener('submit', e => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                const btn = document.getElementById('login-button');
                document.getElementById('login-error').textContent = '';
                btn.disabled = true; btn.textContent = 'Logging in...';
                auth.signInWithEmailAndPassword(email, password)
                    .catch(err => { document.getElementById('login-error').textContent = err.message; })
                    .finally(() => { btn.disabled = false; btn.textContent = 'Login'; });
            });
            
            document.getElementById('google-login-btn').addEventListener('click', () => {
                const provider = new firebase.auth.GoogleAuthProvider();
                document.getElementById('login-error').textContent = '';
                auth.signInWithPopup(provider).catch(err => { document.getElementById('login-error').textContent = err.message; });
            });

            logoutBtn.addEventListener('click', () => {
                if (bannersListener) bannersListener();
                auth.signOut()
            });

            function initializeApp() {
                setupNavigation();
                setupActionListeners();
                navigateToScreen('dashboard-screen');
            }

            // --- NAVIGATION ---
            function setupNavigation() {
                navLinks.forEach(link => {
                    if (!link.id.includes('logout')) {
                        link.addEventListener('click', e => {
                            e.preventDefault();
                            navigateToScreen(link.dataset.target);
                            document.body.classList.remove('nav-open');
                        });
                    }
                });
                menuToggle.addEventListener('click', () => document.body.classList.toggle('nav-open'));
                overlay.addEventListener('click', () => document.body.classList.remove('nav-open'));
            }

            function navigateToScreen(targetId) {
                if (bannersListener) {
                    bannersListener(); 
                    bannersListener = null;
                }
                navLinks.forEach(l => l.classList.remove('active'));
                const activeLink = document.querySelector(`.nav-link[data-target="${targetId}"]`);
                if (activeLink) {
                    activeLink.classList.add('active');
                    headerTitle.textContent = activeLink.dataset.title;
                }
                
                appScreens.forEach(s => s.classList.remove('active'));
                document.getElementById(targetId).classList.add('active');
                
                switch(targetId) {
                    case 'dashboard-screen':
                        fetchDashboardStats();
                        break;
                    case 'users-screen': fetchUsers(); break;
                    case 'posts-screen': fetchPosts(); break;
                    case 'notifications-screen': fetchNotifications(); break;
                    case 'banner-screen': listenForBanners(); break;
                }
            }

            // --- DATA FETCHING & RENDERING ---
            async function fetchDashboardStats() {
                try {
                    const [usersSnap, postsSnap, notifsSnap, bannersSnap] = await Promise.all([
                        db.collection('users').get(), 
                        db.collection('posts').get(),
                        db.collection('notifications').get(),
                        db.collection('banners').get()
                    ]);
                    document.getElementById('total-users-stat').textContent = usersSnap.size;
                    document.getElementById('total-posts-stat').textContent = postsSnap.size;
                    document.getElementById('total-notifications-stat').textContent = notifsSnap.size;
                    document.getElementById('total-banners-stat').textContent = bannersSnap.size;
                } catch (e) { console.error(e); showToast("Could not load dashboard stats.", "error"); }
            }

            async function fetchUsers() {
                const tableBody = document.getElementById('users-table-body');
                tableBody.innerHTML = loadingHTML(5);
                try {
                    const snap = await db.collection('users').orderBy('createdAt', 'desc').get();
                    if (snap.empty) { tableBody.innerHTML = noDataHTML('users', 5); return; }
                    tableBody.innerHTML = snap.docs.map(doc => {
                        const d = { id: doc.id, ...doc.data() };
                        return `<tr><td>${d.name||'N/A'}</td><td>${d.email}</td><td>@${d.handel||'N/A'}</td><td>${d.createdAt?.toDate().toLocaleDateString()||'N/A'}</td>
                        <td class="table-actions">
                            <button class="icon-button edit" data-id="${d.id}" data-collection="users"><span class="material-symbols-outlined">edit</span></button>
                            <button class="icon-button delete" data-id="${d.id}" data-name="${d.name||d.email}"><span class="material-symbols-outlined">delete</span></button>
                        </td></tr>`;
                    }).join('');
                } catch (e) { tableBody.innerHTML = `<tr><td colspan="5" class="table-placeholder" style="color:var(--error-color)">Error loading users.</td></tr>`; }
            }
            
            async function fetchPosts() {
                const tableBody = document.getElementById('posts-table-body');
                tableBody.innerHTML = loadingHTML(4);
                try {
                    const snap = await db.collection('posts').orderBy('createdAt', 'desc').get();
                    if (snap.empty) { tableBody.innerHTML = noDataHTML('posts', 4); return; }
                    tableBody.innerHTML = snap.docs.map(doc => {
                        const d = { id: doc.id, ...doc.data() };
                        return `<tr><td class="wrap">${d.title}</td><td>${d.authorName||d.authorEmail}</td><td>${d.createdAt?.toDate().toLocaleDateString()||'N/A'}</td>
                        <td class="table-actions">
                             <button class="icon-button edit" data-id="${d.id}" data-collection="posts"><span class="material-symbols-outlined">edit</span></button>
                            <button class="icon-button delete" data-id="${d.id}" data-name="${d.title}"><span class="material-symbols-outlined">delete</span></button>
                        </td></tr>`;
                    }).join('');
                } catch (e) { tableBody.innerHTML = `<tr><td colspan="4" class="table-placeholder" style="color:var(--error-color)">Error loading posts.</td></tr>`; }
            }

            async function fetchNotifications() {
                const tableBody = document.getElementById('notifications-table-body');
                tableBody.innerHTML = loadingHTML(5);
                try {
                    const snap = await db.collection('notifications').orderBy('createdAt', 'desc').get();
                    if (snap.empty) { tableBody.innerHTML = noDataHTML('notifications', 5); return; }
                    tableBody.innerHTML = snap.docs.map(doc => {
                        const d = { id: doc.id, ...doc.data() };
                        const msg = d.message || '';
                        return `<tr><td class="wrap">${msg}</td><td>${d.authorEmail||'System'}</td><td>${d.type||'N/A'}</td><td>${d.createdAt?.toDate().toLocaleString()||'N/A'}</td>
                        <td class="table-actions">
                             <button class="icon-button edit" data-id="${d.id}" data-collection="notifications"><span class="material-symbols-outlined">edit</span></button>
                            <button class="icon-button delete" data-id="${d.id}" data-name="${msg.substring(0, 30)}..."><span class="material-symbols-outlined">delete</span></button>
                        </td></tr>`;
                    }).join('');
                } catch (e) { tableBody.innerHTML = `<tr><td colspan="5" class="table-placeholder" style="color:var(--error-color)">Error loading notifications.</td></tr>`; }
            }

            function listenForBanners() {
                const tableBody = document.getElementById('banners-table-body');
                tableBody.innerHTML = loadingHTML(2);

                bannersListener = db.collection('banners').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
                    if (snapshot.empty) {
                        tableBody.innerHTML = noDataHTML('banners', 2);
                        return;
                    }
                    tableBody.innerHTML = snapshot.docs.map(doc => {
                        const banner = { id: doc.id, ...doc.data() };
                        return `
                            <tr>
                                <td>${banner.name || 'N/A'}</td>
                                <td class="table-actions">
                                    <button class="icon-button edit" data-id="${banner.id}" data-collection="banners">
                                        <span class="material-symbols-outlined">edit</span>
                                    </button>
                                    <button class="icon-button delete" data-id="${banner.id}">
                                        <span class="material-symbols-outlined">delete</span>
                                    </button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                }, error => {
                    console.error("Error fetching banners:", error);
                    tableBody.innerHTML = `<tr><td colspan="2" class="table-placeholder" style="color:var(--error-color)">Error loading banners.</td></tr>`;
                });
            }

            // --- ACTION EVENT LISTENERS ---
            function setupActionListeners() {
                document.getElementById('users-table-body').addEventListener('click', e => {
                    const deleteBtn = e.target.closest('button.delete');
                    if (deleteBtn) confirmAction(`Delete User: ${deleteBtn.dataset.name}`, `This will delete the user's profile and all their posts.`, () => deleteUser(deleteBtn.dataset.id));
                    
                    const editBtn = e.target.closest('button.edit');
                    if (editBtn) openEditCreateModal('users', editBtn.dataset.id);
                });

                document.getElementById('posts-table-body').addEventListener('click', e => {
                    const deleteBtn = e.target.closest('button.delete');
                    if (deleteBtn) confirmAction(`Delete Post: ${deleteBtn.dataset.name}`, `Are you sure you want to permanently delete this post?`, () => deletePost(deleteBtn.dataset.id));

                    const editBtn = e.target.closest('button.edit');
                    if (editBtn) openEditCreateModal('posts', editBtn.dataset.id);
                });

                document.getElementById('notifications-table-body').addEventListener('click', e => {
                    const deleteBtn = e.target.closest('button.delete');
                    if (deleteBtn) confirmAction(`Delete Notification`, `Permanently delete this notification: "${deleteBtn.dataset.name}"?`, () => deleteNotification(deleteBtn.dataset.id));

                     const editBtn = e.target.closest('button.edit');
                    if (editBtn) openEditCreateModal('notifications', editBtn.dataset.id);
                });

                document.getElementById('add-user-btn').addEventListener('click', () => openEditCreateModal('users'));
                document.getElementById('add-post-btn').addEventListener('click', () => openEditCreateModal('posts'));
                document.getElementById('add-notification-btn').addEventListener('click', () => openEditCreateModal('notifications'));

                document.getElementById('add-banner-form').addEventListener('submit', async e => {
                    e.preventDefault();
                    const btn = document.getElementById('add-banner-btn');
                    const redirectUrl = document.getElementById('banner-redirect-url').value.trim();
                    const bannerData = {
                        name: document.getElementById('banner-name').value.trim(),
                        imageUrl: document.getElementById('banner-image-url').value.trim(),
                        redirectUrl: redirectUrl || '',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    btn.disabled = true;
                    btn.textContent = 'Adding...';
                    try {
                        await db.collection('banners').add(bannerData);
                        showToast('Banner added successfully!', 'success');
                        e.target.reset();
                    } catch (err) {
                        showToast('Error adding banner.', 'error');
                        console.error("Add banner error:", err);
                    } finally {
                        btn.disabled = false;
                        btn.textContent = 'Add Banner';
                    }
                });

                document.getElementById('banners-table-body').addEventListener('click', e => {
                    const deleteBtn = e.target.closest('button.delete');
                    if (deleteBtn) {
                        confirmAction('Delete Banner', 'Are you sure you want to permanently delete this banner?', () => deleteBanner(deleteBtn.dataset.id));
                    }
                    const editBtn = e.target.closest('button.edit');
                    if (editBtn) {
                        openEditCreateModal('banners', editBtn.dataset.id);
                    }
                });
            }

            // --- DELETION LOGIC ---
            async function deleteUser(userId) {
                try {
                    const postsQuery = db.collection('posts').where('authorId', '==', userId);
                    const postsSnap = await postsQuery.get();
                    const batch = db.batch();
                    postsSnap.forEach(doc => batch.delete(doc.ref));
                    batch.delete(db.collection('users').doc(userId));
                    await batch.commit();
                    showToast('User and posts deleted.', 'success');
                    fetchUsers(); fetchDashboardStats();
                } catch (e) { showToast('Failed to delete user.', 'error'); }
            }

            async function deletePost(postId) {
                try {
                    await db.collection('posts').doc(postId).delete();
                    showToast('Post deleted.', 'success');
                    fetchPosts(); fetchDashboardStats();
                } catch (e) { showToast('Failed to delete post.', 'error'); }
            }

            async function deleteNotification(notifId) {
                try {
                    await db.collection('notifications').doc(notifId).delete();
                    showToast('Notification deleted.', 'success');
                    fetchNotifications(); fetchDashboardStats();
                } catch (e) { showToast('Failed to delete notification.', 'error'); }
            }

            async function deleteBanner(bannerId) {
                try {
                    await db.collection('banners').doc(bannerId).delete();
                    showToast('Banner deleted.', 'success');
                } catch (e) {
                    console.error("Error deleting banner:", e);
                    showToast('Failed to delete banner.', 'error');
                }
            }
             
            // --- EDIT/CREATE MODAL ---
            const editCreateModal = document.getElementById('edit-create-modal');
            const editCreateForm = document.getElementById('edit-create-form');
            
            async function openEditCreateModal(collection, docId = null) {
                const isEditing = docId !== null;
                editCreateModal.classList.add('visible');
                editCreateForm.innerHTML = `<div class="spinner"></div>`;

                let docData = {};
                if(isEditing) {
                    const docRef = await db.collection(collection).doc(docId).get();
                    docData = docRef.data();
                }

                document.getElementById('edit-create-modal-title').textContent = `${isEditing ? 'Edit' : 'Create'} ${collection.slice(0, -1)}`;

                let formHTML = '';

                switch(collection) {
                    case 'users':
                        formHTML = `
                            <div class="form-group"><label>Name</label><input type="text" name="name" value="${docData.name || ''}" required></div>
                            <div class="form-group"><label>Email</label><input type="email" name="email" value="${docData.email || ''}" ${isEditing ? 'disabled' : ''} required></div>
                            <div class="form-group"><label>Handel</label><input type="text" name="handel" value="${docData.handel || ''}"></div>
                            ${!isEditing ? '<div class="form-group"><label>Password</label><input type="password" name="password" required></div>' : ''}
                        `;
                        break;
                    case 'posts':
                        formHTML = `
                            <div class="form-group"><label>Title</label><input type="text" name="title" value="${docData.title || ''}" required></div>
                            <div class="form-group"><label>Content</label><textarea name="content" required>${docData.content || ''}</textarea></div>
                            <div class="form-group"><label>Author Email</label><input type="email" name="authorEmail" value="${docData.authorEmail || ''}" required></div>
                        `;
                        break;
                    case 'notifications':
                        formHTML = `
                            <div class="form-group"><label>Message</label><textarea name="message" required>${docData.message || ''}</textarea></div>
                            <div class="form-group"><label>Type</label><input type="text" name="type" value="${docData.type || ''}" required></div>
                            <div class="form-group"><label>Author Email</label><input type="email" name="authorEmail" value="${docData.authorEmail || ''}"></div>
                        `;
                        break;
                    case 'banners':
                        formHTML = `
                            <div class="form-group"><label>Banner Name</label><input type="text" name="name" value="${docData.name || ''}" required></div>
                            <div class="form-group"><label>Image URL</label><input type="url" name="imageUrl" value="${docData.imageUrl || ''}" required></div>
                            <div class="form-group"><label>Redirect URL (optional)</label><input type="url" name="redirectUrl" value="${docData.redirectUrl || ''}"></div>
                        `;
                        break;
                }

                editCreateForm.innerHTML = formHTML + `<div class="modal-actions"><button type="button" class="btn btn-secondary" id="edit-create-cancel-btn">Cancel</button><button type="submit" class="btn btn-primary">${isEditing ? 'Save Changes' : 'Create'}</button></div>`;
                
                editCreateForm.onsubmit = (e) => {
                    e.preventDefault();
                    handleFormSubmit(collection, docId, new FormData(editCreateForm));
                };
            }

            async function handleFormSubmit(collection, docId, formData) {
                const data = Object.fromEntries(formData.entries());
                const isEditing = docId !== null;

                try {
                    if (collection === 'banners') {
                        data.redirectUrl = data.redirectUrl || '';
                    }

                    if (isEditing) {
                        await db.collection(collection).doc(docId).update(data);
                        showToast(`${collection.slice(0, -1)} updated successfully.`, 'success');
                    } else {
                        if (collection === 'users') {
                            const userCredential = await auth.createUserWithEmailAndPassword(data.email, data.password);
                            await db.collection('users').doc(userCredential.user.uid).set({
                                name: data.name,
                                email: data.email,
                                handel: data.handel,
                                createdAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        } else {
                            data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                            await db.collection(collection).add(data);
                        }
                        showToast(`${collection.slice(0, -1)} created successfully.`, 'success');
                    }
                    closeEditCreateModal();
                    navigateToScreen(`${collection}-screen`);
                    fetchDashboardStats();
                } catch (error) {
                    showToast(`Error: ${error.message}`, 'error');
                }
            }

            function closeEditCreateModal() {
                editCreateModal.classList.remove('visible');
                editCreateForm.innerHTML = '';
            }
            
            editCreateModal.addEventListener('click', e => {
                if (e.target === editCreateModal || e.target.closest('#edit-create-modal-close-btn') || e.target.closest('#edit-create-cancel-btn')) {
                    closeEditCreateModal();
                }
            });

            // --- UI HELPERS (MODAL & TOAST) ---
            const modal = document.getElementById('confirmation-modal');
            let confirmCallback = null;
            function confirmAction(title, text, onConfirm) {
                document.getElementById('modal-title').textContent = title;
                document.getElementById('modal-text').textContent = text;
                confirmCallback = onConfirm;
                modal.classList.add('visible');
            }
            document.getElementById('modal-confirm-btn').addEventListener('click', () => { if (confirmCallback) confirmCallback(); modal.classList.remove('visible'); });
            document.getElementById('modal-cancel-btn').addEventListener('click', () => modal.classList.remove('visible'));
            modal.addEventListener('click', e => { if (e.target === modal) modal.classList.remove('visible'); });

            function showToast(message, type = 'success') {
                const toastContainer = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                toastContainer.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            }
        });
    </script>
</body>
</html>
