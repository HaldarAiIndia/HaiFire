<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chat - HaiFire</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <link rel="stylesheet" href="aistudio_Style.css">
    <style>
        /* Layout Fixes */
        html, body { height: 100%; overflow: hidden; margin: 0; padding: 0; }
        
        .app-container { 
            height: 100%; 
            height: 100dvh; /* Mobile viewport fix */
            display: flex; 
            width: 100%;
        }

        /* Sidebar Fixes from home.html */
        #left-sidebar {
            flex-shrink: 0;
            width: 260px;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border-color);
            background-color: var(--bg-secondary);
            z-index: 1000;
            transition: transform 0.3s ease;
        }

        @media (max-width: 1023px) {
            #left-sidebar {
                position: fixed; top: 0; left: 0; bottom: 0;
                transform: translateX(-100%);
            }
            body.left-sidebar-open #left-sidebar {
                transform: translateX(0);
            }
            body.left-sidebar-open .overlay {
                opacity: 1; visibility: visible;
            }
        }

        .main-wrapper { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            height: 100%; 
            position: relative;
            width: 100%;
        }
        
        /* Header Fix */
        .main-header {
            flex-shrink: 0; /* Prevent header from shrinking */
        }

        /* Chat Area Fixes */
        .chat-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: var(--bg-primary);
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }

        .chat-input-container {
            flex-shrink: 0; /* Input stays at bottom */
            padding: 10px 15px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: max(10px, env(safe-area-inset-bottom)); /* iPhone X fix */
        }

        /* Message Styling */
        .chat-message {
            max-width: 75%;
            padding: 10px 15px;
            border-radius: 18px;
            font-size: 0.95rem;
            position: relative;
            word-wrap: break-word;
            line-height: 1.4;
        }
        .ai-message { /* Received */
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border-bottom-left-radius: 4px;
            align-self: flex-start;
        }
        .user-message { /* Sent */
            background: var(--text-active);
            color: var(--bg-primary); /* Dark text on accent color */
            border-bottom-right-radius: 4px;
            align-self: flex-end;
        }
        /* Fix text color for user message if background is dark/blue */
        .user-message { color: #fff; } 

        .msg-time {
            font-size: 0.7rem;
            opacity: 0.7;
            margin-top: 4px;
            text-align: right;
            display: block;
        }

        /* Skeleton */
        .sk-msg-left { align-self: flex-start; width: 50%; height: 40px; border-radius: 18px; border-bottom-left-radius: 4px; background: var(--bg-tertiary); animation: pulse 1.5s infinite; margin-bottom: 10px; }
        .sk-msg-right { align-self: flex-end; width: 50%; height: 40px; border-radius: 18px; border-bottom-right-radius: 4px; background: var(--bg-tertiary); animation: pulse 1.5s infinite; margin-bottom: 10px; opacity: 0.5; }
        @keyframes pulse { 0% {opacity:0.5;} 50% {opacity:1;} 100% {opacity:0.5;} }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Overlay & Sidebar -->
        <div class="overlay" id="overlay"></div>
        <aside id="left-sidebar">
            <div class="sidebar-header">HaiFire</div>
            <div class="sidebar-content">
                <nav class="sidebar-nav">
                    <a href="home.html"><span class="material-symbols-outlined">home</span>Home</a>
                    <a href="search.html"><span class="material-symbols-outlined">search</span>Search</a>
                    <a href="post.html"><span class="material-symbols-outlined">add_circle</span>Create</a>
                    <a href="requests.html"><span class="material-symbols-outlined">notifications</span>Alerts</a>
                    <a href="dm.html" class="active"><span class="material-symbols-outlined">chat</span>Messages</a>
                    <a href="profile.html"><span class="material-symbols-outlined">person</span>Profile</a>
                </nav>
            </div>
        </aside>

        <div class="main-wrapper">
            <header class="main-header">
                <!-- Added ID for menu toggle logic -->
                <button id="menu-toggle" class="icon-button"><span class="material-symbols-outlined">menu</span></button>
                <button class="icon-button" onclick="history.back()" style="margin-right: 10px;"><span class="material-symbols-outlined">arrow_back</span></button>
                <div class="header-title" id="chatHeaderName" style="flex:1;">Chat</div>
            </header>

            <div class="chat-area" id="messageContainer">
                <!-- Skeleton Loader -->
                <div id="skeletonLoader">
                    <div class="sk-msg-left"></div>
                    <div class="sk-msg-right"></div>
                    <div class="sk-msg-left" style="width: 30%"></div>
                    <div class="sk-msg-right" style="width: 60%"></div>
                </div>
            </div>

            <div class="chat-input-container">
                <button class="icon-button"><span class="material-symbols-outlined">add</span></button>
                <input type="text" id="msgInput" placeholder="Type a message..." style="border-radius: 20px;">
                <button class="send-button" id="sendBtn"><span class="material-symbols-outlined">send</span></button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyB2mV0bya1fD17kQZQeMP11a9mlK-sVEnc",
            authDomain: "citas-bd0a3.firebaseapp.com",
            databaseURL: "https://citas-bd0a3-default-rtdb.firebaseio.com",
            projectId: "citas-bd0a3",
            storageBucket: "citas-bd0a3.firebasestorage.app",
            messagingSenderId: "1082213903517",
            appId: "1:1082213903517:web:22409e051e5442f37ef874",
            measurementId: "G-TXKMGDLMVB"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // UI Logic (Mobile Sidebar)
        const menuToggle = document.getElementById('menu-toggle');
        const overlay = document.getElementById('overlay');
        const body = document.body;

        // Hide sidebar toggle on desktop
        if (window.innerWidth >= 1024) {
            menuToggle.style.display = 'none';
        }

        menuToggle.addEventListener('click', () => body.classList.toggle('left-sidebar-open'));
        overlay.addEventListener('click', () => body.classList.remove('left-sidebar-open'));

        // Chat Logic
        const params = new URLSearchParams(window.location.search);
        const targetUid = params.get('uid');
        let targetName = params.get('name');
        let currentUser;
        let chatId;

        if(!targetUid) window.location.href = 'dm.html';
        
        // Initial Header Set
        document.getElementById('chatHeaderName').textContent = targetName || "Loading...";

        auth.onAuthStateChanged(user => {
            if(user) {
                currentUser = user;
                fetchTargetInfo(); // Ensure we have the name
                initChat();
            } else window.location.href = 'index.html';
        });

        async function fetchTargetInfo() {
            if(!targetName) {
                try {
                    const doc = await db.collection('users').doc(targetUid).get();
                    if(doc.exists) {
                        targetName = doc.data().username;
                        document.getElementById('chatHeaderName').textContent = targetName;
                    }
                } catch(e) { console.error(e); }
            }
        }

        function initChat() {
            // Create unique chat ID (Alphabetical sort ensures same ID for both users)
            chatId = [currentUser.uid, targetUid].sort().join('_');
            
            const container = document.getElementById('messageContainer');
            const skeleton = document.getElementById('skeletonLoader');

            db.collection('chats').doc(chatId).collection('messages')
                .orderBy('timestamp', 'asc')
                .onSnapshot(snapshot => {
                    skeleton.style.display = 'none';
                    container.innerHTML = ''; 
                    
                    if(snapshot.empty) {
                        container.innerHTML = '<div class="text-center" style="color:var(--text-secondary); margin-top:20px;">Say hello! ðŸ‘‹</div>';
                        return;
                    }

                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const isMe = data.senderId === currentUser.uid;
                        
                        // FIX: Timestamp null check (prevents crash on immediate send)
                        let timeString = 'Sending...';
                        if (data.timestamp) {
                            timeString = new Date(data.timestamp.toDate()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                        }

                        const div = document.createElement('div');
                        div.className = `chat-message ${isMe ? 'user-message' : 'ai-message'}`;
                        div.innerHTML = `
                            ${data.text}
                            <span class="msg-time">${timeString}</span>
                        `;
                        container.appendChild(div);
                    });
                    
                    // Auto-scroll to bottom
                    container.scrollTop = container.scrollHeight;
                });
        }

        // Send Logic
        const sendBtn = document.getElementById('sendBtn');
        const msgInput = document.getElementById('msgInput');

        sendBtn.addEventListener('click', sendMessage);
        msgInput.addEventListener('keypress', (e) => {
            if(e.key === 'Enter') sendMessage();
        });

        async function sendMessage() {
            const text = msgInput.value.trim();
            if(!text) return;

            msgInput.value = ''; // Clear immediately
            
            try {
                await db.collection('chats').doc(chatId).collection('messages').add({
                    text: text,
                    senderId: currentUser.uid,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Optional: Update 'lastMessage' in a parent collection for the DM list
                /* 
                await db.collection('chats').doc(chatId).set({
                    lastMessage: text,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    participants: [currentUser.uid, targetUid]
                }, { merge: true });
                */

            } catch(e) {
                console.error("Error sending:", e);
                alert("Failed to send message.");
            }
        }
    </script>
</body>
</html>