<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Post - HaiFire</title>


    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/favicon.png">
    <link rel="apple-touch-icon" href="/favicon.png" />
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <link rel="stylesheet" href="aistudio_Style.css">
    <style>
        .preview-area {
            margin-top: 15px;
            position: relative;
            display: none;
            border-radius: 8px;
            overflow: hidden;
        }
        .preview-area img { width: 100%; border-radius: 8px; }
        .remove-img-btn {
            position: absolute; top: 10px; right: 10px;
            background: rgba(0,0,0,0.6); color: white;
            border-radius: 50%; padding: 5px;
            cursor: pointer;
        }
        .action-bar {
            display: flex; gap: 15px; margin-top: 15px;
            border-top: 1px solid var(--border-color); padding-top: 15px;
        }
        .upload-btn {
            color: var(--text-active); display: flex; align-items: center; gap: 5px; cursor: pointer;
        }
        
        /* Skeleton */
        .skeleton { background: var(--bg-tertiary); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Overlay & Sidebar (Same structure) -->
        <div class="overlay" id="overlay"></div>
        <aside id="left-sidebar">
            <div class="sidebar-header">HaiFire</div>
            <div class="sidebar-content">
                <nav class="sidebar-nav">
                    <a href="home.html"><span class="material-symbols-outlined">home</span>Home</a>
                    <a href="search.html"><span class="material-symbols-outlined">search</span>Search</a>
                    <a href="post.html" class="active"><span class="material-symbols-outlined">add_circle</span>Create</a>
                    <a href="requests.html"><span class="material-symbols-outlined">notifications</span>Alerts</a>
                    <a href="dm.html"><span class="material-symbols-outlined">chat</span>Messages</a>
                    <a href="profile.html"><span class="material-symbols-outlined">person</span>Profile</a>
                </nav>
            </div>
        </aside>

        <div class="main-wrapper">
            <header class="main-header">
                <button id="menu-toggle" class="icon-button"><span class="material-symbols-outlined">menu</span></button>
                <div class="header-title">Create Post</div>
            </header>

            <main class="content-area">
                <div class="content-wrapper">
                    <!-- Loading State -->
                    <div id="loadingState" style="display:none; text-align: center; color: var(--text-active);">
                        <span class="material-symbols-outlined skeleton" style="font-size: 48px; border-radius: 50%;">cloud_upload</span>
                        <p>Publishing your post...</p>
                    </div>

                    <div class="profile-card" id="postFormCard">
                        <div class="form-group">
                            <textarea id="postContent" rows="5" placeholder="What's on your mind?"></textarea>
                        </div>
                        
                        <div class="preview-area" id="imagePreviewContainer">
                            <img id="imagePreview" src="">
                            <div class="remove-img-btn" id="removeImage"><span class="material-symbols-outlined">close</span></div>
                        </div>

                        <div class="action-bar">
                            <label class="upload-btn">
                                <span class="material-symbols-outlined">image</span> Photo
                                <input type="file" id="imageInput" accept="image/*" hidden>
                            </label>
                            <div style="flex:1"></div>
                            <button class="btn btn-primary" id="publishBtn">Post</button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        // Init Firebase (Use same config)
        const firebaseConfig = { apiKey: "AIzaSyB2mV0bya1fD17kQZQeMP11a9mlK-sVEnc", authDomain: "citas-bd0a3.firebaseapp.com", databaseURL: "https://citas-bd0a3-default-rtdb.firebaseio.com", projectId: "citas-bd0a3", storageBucket: "citas-bd0a3.firebasestorage.app", messagingSenderId: "1082213903517", appId: "1:1082213903517:web:22409e051e5442f37ef874", measurementId: "G-TXKMGDLMVB" };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const IMGBB_API_KEY = "7184e56bb0953c0545409c441c402a66";

        let currentUser = null;
        let currentUsername = "";

        // UI Logic
        const menuToggle = document.getElementById('menu-toggle');
        const body = document.body;
        menuToggle.addEventListener('click', () => body.classList.toggle('left-sidebar-open'));
        document.getElementById('overlay').addEventListener('click', () => body.classList.remove('left-sidebar-open'));

        auth.onAuthStateChanged(async user => {
            if(user) {
                currentUser = user;
                const doc = await db.collection('users').doc(user.uid).get();
                if(doc.exists) currentUsername = doc.data().username;
            } else window.location.href = 'index.html';
        });

        // Image Handling
        const imgInput = document.getElementById('imageInput');
        const preview = document.getElementById('imagePreview');
        const previewCont = document.getElementById('imagePreviewContainer');
        
        imgInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    preview.src = e.target.result;
                    previewCont.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('removeImage').addEventListener('click', () => {
            imgInput.value = '';
            previewCont.style.display = 'none';
        });

        // Publish
        document.getElementById('publishBtn').addEventListener('click', async () => {
            const content = document.getElementById('postContent').value.trim();
            const file = imgInput.files[0];

            if(!content && !file) return alert("Please add content or an image");

            document.getElementById('postFormCard').style.display = 'none';
            document.getElementById('loadingState').style.display = 'block';

            let imageUrl = null;
            if(file) {
                const formData = new FormData();
                formData.append('image', file);
                try {
                    const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method:'POST', body: formData });
                    const data = await res.json();
                    if(data.success) imageUrl = data.data.url;
                } catch(e) { console.error(e); }
            }

            await db.collection('posts').add({
                userId: currentUser.uid,
                username: currentUsername,
                content: content,
                imageUrl: imageUrl,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                likesCount: 0,
                likes: []
            });

            window.location.href = 'home.html';
        });
    </script>
</body>
</html>
